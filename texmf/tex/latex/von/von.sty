%
% BOOST SOFTWARE LICENSE - VERSION 1.0 - 17 AUGUST 2003
%
% Copyright (c) 2022 Evan Chen [evan at evanchen.cc]
% https://web.evanchen.cc/ || github.com/vEnhance
%
% Available for download at:
% https://github.com/vEnhance/dotfiles/blob/main/texmf/tex/latex/von/von.sty
%
% Permission is hereby granted, free of charge, to any person or organization
% obtaining a copy of the software and accompanying documentation covered by
% this license (the "Software") to use, reproduce, display, distribute,
% execute, and transmit the Software, and to prepare derivative works of the
% Software, and to permit third-parties to whom the Software is furnished to
% do so, all subject to the following:
%
% The copyright notices in the Software and this entire statement, including
% the above license grant, this restriction and the following disclaimer,
% must be included in all copies of the Software, in whole or in part, and
% all derivative works of the Software, unless such copies or derivative
% works are solely in the form of machine-executable object code generated by
% a source language processor.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
% FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
% SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
% FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
% ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
% DEALINGS IN THE SOFTWARE.

\ProvidesPackage{von}[2016/08/06 v1.0 VON problem manager]
\usepackage{pythontex}
\usepackage{xstring}
\usepackage{xifthen}
\usepackage{color}
% Generate a unique name using the first 12 characters of an MD5 sum
% #1 is always index
% #2 is always source
\newif\ifvonbrave\vonbravefalse
\DeclareOption{brave}{\vonbravetrue}
\DeclareOption{timid}{\vonbravefalse}

\newcommand{\vonhook}[1]{}
\newcommand{\vonmarginstyle}{\scriptsize\ttfamily\color{Green}}%
\newcommand{\enablevonmargins}{%
  \renewcommand{\vonhook}[1]{\marginpar{\vonmarginstyle{##1}}}}
\DeclareOption{vonmargin}{\enablevonmargins}
\ProcessOptions\relax

\begin{pycode}
import von.api as api
\end{pycode}
\setpythontexoutputdir{.}

\newcommand{\@voncore}[2]{%
  \ifvonbrave\py{api.get("#2", True).bodies[#1]}%
  \else\py{api.get("#2").bodies[#1]}\fi
  \vonhook{#2}}% for example a margin par
\newcommand{\voninclude}[2][0]{\@voncore{#1}{#2}}
\newcommand{\vonprehook}[1]{}
\newcommand{\vonposthook}[1]{}

\def\von{\@ifstar\@vonstar\@von}
\newcommand{\vonenvname}{problem}
\newcommand{\@von}[2][]{%
  \pyc{entry = api.get("#2")}
  \pyc{src = "#1" or "#2"}
  \begin{\vonenvname}[\py{(r'\href{' + entry.url + '}{' + src + '}') if entry.url is not None else src}]%
    \vonprehook{#2}
    \voninclude{#2}%
    \vonposthook{#2}
  \end{\vonenvname}%
}
\newcommand{\@vonstar}[1]{%
  \begin{\vonenvname}
    \vonprehook{#1}
    \voninclude{#1}
    \vonposthook{#1}
  \end{\vonenvname}
  }
